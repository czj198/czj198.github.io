<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>武汉二手房数据可视化+分析建议（极速加载版）</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; }
        #mapContainer { width: 100%; height: 100%; }
        
        /* 功能选项面板 */
        #functionPanel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 200px;
        }
        .function-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .function-item {
            padding: 8px 0;
            color: #1e5799;
            cursor: pointer;
            border-bottom: 1px dashed #f0f0f0;
            transition: color 0.2s;
        }
        .function-item:hover {
            color: #16457a;
        }
        
        /* 筛选查询面板 */
        #filterSearchPanel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 320px;
        }
        .panel-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        .control-group {
            margin-bottom: 15px;
        }
        .control-label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #666;
        }
        .control-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .range-controls {
            display: flex;
            gap: 10px;
        }
        .range-controls input {
            flex: 1;
        }
        .action-button {
            width: 100%;
            padding: 10px;
            background: #1e5799;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .action-button:hover {
            background: #16457a;
        }
        .action-button.reset {
            background: #666;
        }
        .result-count {
            font-size: 14px;
            color: #333;
            text-align: center;
            margin-top: 5px;
            padding-top: 10px;
            border-top: 1px dashed #eee;
        }

        /* 图例 */
        #legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 200px;
        }
        .legend-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            border: 1px solid #fff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .legend-label {
            font-size: 14px;
            color: #666;
        }

        /* 弹窗面板（优化加载） */
        .popup-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1002;
            width: 80%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
        }
        .popup-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .popup-content img {
            width: 100%;
            border-radius: 4px;
            margin-bottom: 15px;
            /* 图片加载失败兜底 */
            background: #f5f5f5;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
        }
        .popup-content p {
            line-height: 1.6;
            color: #666;
            margin: 8px 0;
        }
        .popup-content .section-title {
            font-weight: bold;
            color: #1e5799;
            margin-top: 15px;
            margin-bottom: 8px;
        }
        .popup-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .popup-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        .popup-btn-suggest {
            background: #1e5799;
            color: white;
        }
        .popup-btn-close {
            background: #666;
            color: white;
        }
        /* 图片加载提示 */
        .img-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 14px;
        }
        .img-container {
            position: relative;
            width: 100%;
            margin-bottom: 15px;
        }

        /* 属性面板 */
        #propertyPanel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1001;
            width: 300px;
            display: none;
        }
        .property-item {
            margin: 10px 0;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .property-key {
            font-weight: bold;
            color: #1e5799;
        }

        /* 加载提示 */
        #loadingTip {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            z-index: 2000;
        }

        /* 新增：管理员登录面板 */
        #adminLoginPanel {
            position: absolute;
            top: 20px;
            left: 240px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 200px;
        }
        .login-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            font-size: 14px;
        }
        .login-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            box-sizing: border-box;
            margin-bottom: 8px;
        }
        .login-btn {
            width: 100%;
            padding: 6px;
            background: #1e5799;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
        }
        .login-status {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 8px;
        }
        .login-success {
            color: #28a745;
        }
        .login-error {
            color: #dc3545;
        }

        /* 新增：评价面板 */
        #commentPanel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1003;
            width: 350px;
            display: none;
        }
        .comment-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .comment-input {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            resize: none;
            margin-bottom: 10px;
        }
        .comment-score {
            margin-bottom: 10px;
        }
        .score-label {
            font-size: 14px;
            color: #666;
            margin-right: 10px;
        }
        .score-star {
            color: #ffc107;
            cursor: pointer;
        }
        .comment-submit {
            width: 100%;
            padding: 8px;
            background: #1e5799;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 15px;
        }
        .comment-list {
            max-height: 200px;
            overflow-y: auto;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        .comment-item {
            padding: 8px 0;
            border-bottom: 1px dashed #f0f0f0;
        }
        .comment-score-display {
            color: #ffc107;
            margin-bottom: 4px;
        }
        .comment-content {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
        }
        .comment-time {
            font-size: 12px;
            color: #999;
        }
        .comment-delete {
            font-size: 12px;
            color: #dc3545;
            cursor: pointer;
            margin-left: 10px;
            display: none; /* 默认隐藏删除按钮，管理员登录后显示 */
        }
        .admin-show .comment-delete {
            display: inline;
        }
        .comment-empty {
            font-size: 14px;
            color: #999;
            text-align: center;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div id="mapContainer"></div>
    <div id="loadingTip">正在加载数据...</div>
    
    <!-- 功能选项面板 -->
    <div id="functionPanel">
        <div class="function-title">分析功能</div>
        <div class="function-item" onclick="openPopup('heatmap')">1. 房价热力图</div>
        <div class="function-item" onclick="openPopup('areaPrice')">2. 单价面积关系图</div>
        <div class="function-item" onclick="openPopup('suggest')">3. 购买建议</div>
    </div>

    <!-- 新增：管理员登录面板 -->
    <div id="adminLoginPanel">
        <div class="login-title">管理员登录</div>
        <input type="text" id="adminAccount" class="login-input" placeholder="账号" value="">
        <input type="password" id="adminPwd" class="login-input" placeholder="密码" value="">
        <button class="login-btn" onclick="adminLogin()">登录</button>
        <div class="login-status" id="loginStatus">未登录</div>
    </div>

    <!-- 图例 -->
    <div id="legend">
        <div class="legend-title">单价图例</div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #ff0000;"></div>
            <div class="legend-label">单价 > 10000元/㎡</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #0066cc;"></div>
            <div class="legend-label">单价 ≤ 10000元/㎡</div>
        </div>
    </div>
    
    <!-- 筛选查询面板 -->
    <div id="filterSearchPanel">
        <div class="panel-title">数据查询与筛选</div>
        <div class="control-group">
            <label class="control-label">关键词查询（小区/区域）</label>
            <input type="text" id="keywordSearch" class="control-input" placeholder="例如：武昌区、东湖小区">
        </div>
        <div class="control-group">
            <label class="control-label">单价区间（元/㎡）</label>
            <div class="range-controls">
                <input type="number" id="minPrice" class="control-input" placeholder="最低" min="0">
                <input type="number" id="maxPrice" class="control-input" placeholder="最高">
            </div>
        </div>
        <div class="control-group">
            <label class="control-label">总价区间（万元）</label>
            <div class="range-controls">
                <input type="number" id="minTotalPrice" class="control-input" placeholder="最低" min="0">
                <input type="number" id="maxTotalPrice" class="control-input" placeholder="最高">
            </div>
        </div>
        <div class="control-group">
            <label class="control-label">面积区间（㎡）</label>
            <div class="range-controls">
                <input type="number" id="minArea" class="control-input" placeholder="最小" min="0">
                <input type="number" id="maxArea" class="control-input" placeholder="最大">
            </div>
        </div>
        <button class="action-button" id="doSearchFilter">查询并筛选</button>
        <button class="action-button reset" id="resetAll">重置所有条件</button>
        <div class="result-count" id="resultCount">加载中...</div>
    </div>

    <!-- 房价热力图弹窗（优化图片加载） -->
    <div id="heatmapPopup" class="popup-panel">
        <div class="popup-title">武汉市二手房房价热力图</div>
        <div class="popup-content">
            <div class="img-container">
                <div class="img-loading" id="heatmapLoading">图片加载中...</div>
                <!-- 方式1：使用你的原图链接（优先） -->
                <img 
                    src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/ff67be6eca864b2ca2d6ffb28ac6d54d.png~tplv-a9rns2rl98-image.png?rcl=202512161102294A53C7FE90AFCADC1108&rk3s=8e244e95&rrcfp=dafada99&x-expires=2082078150&x-signature=188tzcrtTDaIkY1ME2hI4dqYk8U%3D" 
                    alt="武汉市二手房房价热力图"
                    onload="hideLoading('heatmapLoading')"
                    onerror="this.src='https://via.placeholder.com/800x600?text=图片加载失败，请刷新重试'">
            </div>
            <div id="heatmapSuggest" style="display: none;">
                <div class="section-title">1. 热力核心区（红色高单价）</div>
                <p>第一梯队（15000-20000 元/㎡）：武昌滨江（积玉桥）、江岸二七滨江、江汉武广商圈，核心驱动：江景资源 + 顶级学区 + 地铁1/2/7号线；</p>
                <p>第二梯队（10000-15000 元/㎡）：洪山光谷、汉阳钟家村、硚口宗关，核心驱动：产业集聚（光谷科创）+ 地铁环线 + 成熟商圈。</p>
                
                <div class="section-title">2. 冷区（蓝色低单价）</div>
                <p>核心远郊（7000-10000 元/㎡）：江夏藏龙岛、黄陂盘龙城、东西湖吴家山，核心制约：通勤距离（距光谷/汉口核心＞30分钟）+ 配套滞后；</p>
                <p>远郊边缘（5000-7000 元/㎡）：新洲阳逻、蔡甸中法生态城，核心制约：无地铁覆盖 + 产业支撑弱。</p>
                
                <div class="section-title">3. 热力分布规律</div>
                <p>单价与“核心城区距离”呈强负相关：距汉口/武昌核心每增加5公里，单价下降约15%；</p>
                <p>地铁沿线溢价显著：已通车地铁站点500米内房源，单价比非沿线高10%-20%；</p>
                <p>学区溢价分化：重点小学（如武昌水果湖一小）学区房单价溢价超40%，普通学区溢价仅5%-10%。</p>
            </div>
        </div>
        <div class="popup-buttons">
            <button class="popup-btn-suggest" onclick="toggleSuggest('heatmap')">查看分析</button>
            <button class="popup-btn-close" onclick="closePopup('heatmap')">关闭</button>
        </div>
    </div>

    <!-- 单价面积关系图弹窗（优化图片加载） -->
    <div id="areaPricePopup" class="popup-panel">
        <div class="popup-title">单价和面积之间的关系</div>
        <div class="popup-content">
            <div class="img-container">
                <div class="img-loading" id="areaPriceLoading">图片加载中...</div>
                <!-- 方式1：使用你的原图链接（优先） -->
                <img 
                    src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/40c76c2121c64120958d20d9c11059eb.png~tplv-a9rns2rl98-image.png?rcl=202512161102294A53C7FE90AFCADC1108&rk3s=8e244e95&rrcfp=dafada99&x-expires=2082078150&x-signature=LV0T3azWCNOUtVYOJv8EzWtQvmo%3D" 
                    alt="单价和面积之间的关系"
                    onload="hideLoading('areaPriceLoading')"
                    onerror="this.src='https://via.placeholder.com/800x500?text=图片加载失败，请刷新重试'">
            </div>
            <div id="areaPriceSuggest" style="display: none;">
                <p>小户型单价溢价显著：50-80㎡房源集中在武昌、江岸等核心城区，配套成熟（地铁/学区），单价比同区域中户型高20%-30%，核心逻辑是“低总价 + 高流通性”；</p>
                <p>中户型性价比最优：80-120㎡是供需平衡点，单价适中且总价可控，武昌洪山、汉阳四新等板块的次新房占比超70%，增值稳定性最强；</p>
                <p>大户型单价折价明显：120㎡以上房源多分布在远城区，单价随面积增大逐步降低，核心制约因素是“置换难度大 + 持有成本高”。</p>
            </div>
        </div>
        <div class="popup-buttons">
            <button class="popup-btn-suggest" onclick="toggleSuggest('areaPrice')">查看分析</button>
            <button class="popup-btn-close" onclick="closePopup('areaPrice')">关闭</button>
        </div>
    </div>

    <!-- 购买建议弹窗 -->
    <div id="suggestPopup" class="popup-panel">
        <div class="popup-title">武汉市二手房购买建议</div>
        <div class="popup-content">
            <div class="section-title">1. 刚需购房（预算有限，50-80㎡）</div>
            <p>优先板块：武昌徐东、江岸后湖、汉阳四新（单价10000-14000 元/㎡，地铁3/6/8号线覆盖，小户型占比超60%）；</p>
            <p>避坑点：远离核心城区老破小（房龄＞20年，无电梯/物业差），优先次新小户型（房龄5-10年）；</p>
            <p>核心逻辑：牺牲部分面积，优先保障“地铁 + 学区”，流通性＞居住舒适度。</p>
            
            <div class="section-title">2. 改善购房（80-120㎡，兼顾性价比与居住品质）</div>
            <p>优先板块：洪山光谷东、汉阳钟家村、硚口汉西（单价9000-12000 元/㎡，中户型占比70%，次新房为主）；</p>
            <p>优选户型：3室2厅（功能性＞面积），优先南北通透、梯户比1:2的房源；</p>
            <p>核心逻辑：中户型是供需平衡点，增值稳定性最强，优先选择“地铁 + 商业 + 公园”三重配套板块。</p>
            
            <div class="section-title">3. 高端改善/投资（120-200㎡）</div>
            <p>优先板块：武昌滨江、江岸二七滨江（大户型单价12000-15000 元/㎡，稀缺江景资源），远城区仅推荐江夏光谷南（产业外溢）；</p>
            <p>避坑点：远离新洲/蔡甸超大户型（换手率＜5%/年），投资属性弱；</p>
            <p>核心逻辑：只选核心板块稀缺资源（江景/学区），长期持有（＞5年）才能兑现增值。</p>
            
            <div class="section-title">4. 纯投资购房</div>
            <p>优先标的：光谷东80-100㎡次新房（单价11000-13000 元/㎡，产业人口导入快，租金回报率2.5%-3%）；</p>
            <p>避坑标的：远城区低单价大户型（租金回报率＜1.5%，换手率低）；</p>
            <p>核心逻辑：投资回报率=租金收益 + 增值收益，优先选择“产业人口导入快 + 地铁规划落地”板块。</p>
            
            <div class="section-title">5. 远城区购房（单价≤10000 元/㎡）</div>
            <p>优先板块：江夏藏龙岛（近光谷，单价8000-10000 元/㎡）、黄陂盘龙城（近汉口，单价7000-9000 元/㎡）；</p>
            <p>核心配套：优先选择地铁7/8/21号线沿线（已通车），避开无地铁规划板块；</p>
            <p>核心逻辑：远城区购房“地铁＞价格＞面积”，通勤便利性是保值核心。</p>
        </div>
        <div class="popup-buttons">
            <button class="popup-btn-close" onclick="closePopup('suggest')">关闭</button>
        </div>
    </div>

    <!-- 属性面板 -->
    <div id="propertyPanel">
        <div class="property-item">
            <span class="property-key">小区:</span> <span id="propCommunity"></span>
        </div>
        <div class="property-item">
            <span class="property-key">区域:</span> <span id="propRegion"></span>
        </div>
        <div class="property-item">
            <span class="property-key">房型:</span> <span id="propLayout"></span>
        </div>
        <div class="property-item">
            <span class="property-key">面积:</span> <span id="propArea"></span> ㎡
        </div>
        <div class="property-item">
            <span class="property-key">单价:</span> <span id="propUnitPrice"></span> 元/㎡
        </div>
        <div class="property-item">
            <span class="property-key">总价:</span> <span id="propTotalPrice"></span> 万元
        </div>
        <button class="action-button" style="margin-top:10px" onclick="openCommentPanel(currentSelectedPoint)">添加评价</button>
        <button class="action-button reset" onclick="document.getElementById('propertyPanel').style.display='none'">关闭</button>
    </div>

    <!-- 新增：评价面板 -->
    <div id="commentPanel">
        <div class="comment-title" id="commentPanelTitle">评价 - <span id="commentCommunityName"></span></div>
        <div class="comment-score">
            <span class="score-label">评分：</span>
            <span class="score-star" onclick="setScore(1)">★</span>
            <span class="score-star" onclick="setScore(2)">★</span>
            <span class="score-star" onclick="setScore(3)">★</span>
            <span class="score-star" onclick="setScore(4)">★</span>
            <span class="score-star" onclick="setScore(5)">★</span>
            <input type="hidden" id="currentScore" value="0">
        </div>
        <textarea class="comment-input" id="commentContent" placeholder="请输入评价内容..."></textarea>
        <button class="comment-submit" onclick="submitComment()">提交评价</button>
        <div class="comment-list" id="commentList">
            <div class="comment-empty">暂无评价</div>
        </div>
        <div class="popup-buttons" style="margin-top:15px">
            <button class="popup-btn-close" onclick="closeCommentPanel()">关闭</button>
        </div>
    </div>

    <!-- 高德安全配置 -->
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: '7e5f2c0059d4114aa0a0141f0182b0c1'
        };
    </script>

    <!-- 引入高德地图API -->
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=a19e8b46119d6277b2f366ab1d2f552c&plugin=AMap.DataService,AMap.DistrictSearch"></script>
    
    <script type="text/javascript">
        // 初始化地图
        var map = new AMap.Map('mapContainer', {
            zoom: 12,
            center: [114.305, 30.593]
        });

        // 全局变量
        var allDataPoints = [];
        var currentMarkers = [];
        var currentSelectedPoint = null; // 当前选中的点位
        var isAdmin = false; // 是否管理员登录
        var commentData = {}; // 存储评价数据 {点位ID: [{score: 5, content: '评价内容', time: '时间戳', id: '评论ID'}]}

        // 页面加载完成后加载数据
        window.onload = async function() {
            await loadBackupMockData(); 
            initSearchFilterControls();
            document.getElementById('loadingTip').style.display = 'none';
            
            // 预加载图片（关键优化：提前加载图片到缓存）
            preloadImages([
                'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/ff67be6eca864b2ca2d6ffb28ac6d54d.png~tplv-a9rns2rl98-image.png?rcl=202512161102294A53C7FE90AFCADC1108&rk3s=8e244e95&rrcfp=dafada99&x-expires=2082078150&x-signature=188tzcrtTDaIkY1ME2hI4dqYk8U%3D',
                'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/40c76c2121c64120958d20d9c11059eb.png~tplv-a9rns2rl98-image.png?rcl=202512161102294A53C7FE90AFCADC1108&rk3s=8e244e95&rrcfp=dafada99&x-expires=2082078150&x-signature=LV0T3azWCNOUtVYOJv8EzWtQvmo%3D'
            ]);
        };

        // 预加载图片（核心优化）
        function preloadImages(imageUrls) {
            imageUrls.forEach(url => {
                const img = new Image();
                img.src = url;
                // 加载完成后存入缓存，后续打开弹窗直接读取
                img.onload = function() {
                    console.log('图片预加载完成：', url);
                };
                img.onerror = function() {
                    console.warn('图片预加载失败：', url);
                };
            });
        }

        // 隐藏图片加载提示
        function hideLoading(loadingId) {
            document.getElementById(loadingId).style.display = 'none';
        }

        // 加载模拟数据
        function loadBackupMockData() {
            var wuhanRegions = ['江岸区', '江汉区', '硚口区', '汉阳区', '武昌区', '青山区', '洪山区'];
            var communityNames = [
                '东湖天下', '保利心语', '百步亭花园', '万科金色城市', '华润置地橡树湾',
                '金地自在城', '福星惠誉国际城', '绿地国际金融城', '融创望江府', '中建大公馆'
            ];
            var layouts = ['2室1厅', '3室1厅', '3室2厅', '4室2厅', '2室2厅'];
            
            for (var i = 0; i < 159; i++) {
                var region = wuhanRegions[Math.floor(Math.random() * wuhanRegions.length)];
                var community = communityNames[i % communityNames.length] + (i < 10 ? '' : i);
                var unitPrice = Math.floor(Math.random() * 15000) + 5000;
                var area = Math.floor(Math.random() * 150) + 50;
                var totalPrice = (unitPrice * area / 10000).toFixed(2);
                
                allDataPoints.push({
                    id: i + 1,
                    小区: community,
                    区域: region,
                    房型: layouts[Math.floor(Math.random() * layouts.length)],
                    面积: area,
                    单价: unitPrice,
                    总价: parseFloat(totalPrice),
                    lnglat: [114.2 + Math.random() * 0.3, 30.5 + Math.random() * 0.2],
                    color: unitPrice > 10000 ? '#ff0000' : '#0066cc'
                });
                // 初始化评价数据
                commentData[i + 1] = [];
            }
            
            showDataPoints(allDataPoints);
            updateResultCount(allDataPoints.length);
        }

        // 显示数据点
        function showDataPoints(points) {
            clearMarkers();
            points.forEach(function(point) {
                if (!point.lnglat || point.lnglat.length !== 2) return;
                
                var markerContent = `<div style="
                    width: 10px;          
                    height: 10px;         
                    background-color: ${point.color};
                    border-radius: 50%;   
                    border: 1px solid #fff; 
                    box-shadow: 0 1px 2px rgba(0,0,0,0.2); 
                    cursor: pointer;
                    transition: transform 0.2s ease; 
                " 
                onmouseover="this.style.transform='scale(1.5)'"  
                onmouseout="this.style.transform='scale(1)'"
                title="${point.小区} - ${point.区域} - ${point.单价}元/㎡"></div>`;
                
                var marker = new AMap.Marker({
                    position: point.lnglat,
                    title: `${point.小区}（${point.区域}）- ${point.单价}元/㎡`,
                    content: markerContent,
                    offset: new AMap.Pixel(-5, -5)
                });
                
                marker.on('click', function() {
                    showPropertyInfo(point);
                    currentSelectedPoint = point; // 记录当前选中的点位
                });
                
                marker.setMap(map);
                currentMarkers.push(marker);
            });
        }

        // 清除标记
        function clearMarkers() {
            currentMarkers.forEach(marker => marker.setMap(null));
            currentMarkers = [];
        }

        // 显示属性信息
        function showPropertyInfo(point) {
            document.getElementById('propCommunity').textContent = point.小区;
            document.getElementById('propRegion').textContent = point.区域;
            document.getElementById('propLayout').textContent = point.房型;
            document.getElementById('propArea').textContent = point.面积;
            document.getElementById('propUnitPrice').textContent = point.单价;
            document.getElementById('propTotalPrice').textContent = point.总价;
            document.getElementById('propertyPanel').style.display = 'block';
        }

        // 初始化筛选控件
        function initSearchFilterControls() {
            document.getElementById('doSearchFilter').addEventListener('click', executeSearchAndFilter);
            document.getElementById('resetAll').addEventListener('click', resetAllConditions);
            document.getElementById('keywordSearch').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') executeSearchAndFilter();
            });
        }

        // 执行筛选
        function executeSearchAndFilter() {
            if (allDataPoints.length === 0) {
                alert('暂无数据可筛选！');
                return;
            }

            var keyword = document.getElementById('keywordSearch').value.trim().toLowerCase();
            var minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
            var maxPrice = parseFloat(document.getElementById('maxPrice').value) || Infinity;
            var minTotalPrice = parseFloat(document.getElementById('minTotalPrice').value) || 0;
            var maxTotalPrice = parseFloat(document.getElementById('maxTotalPrice').value) || Infinity;
            var minArea = parseFloat(document.getElementById('minArea').value) || 0;
            var maxArea = parseFloat(document.getElementById('maxArea').value) || Infinity;

            var filteredPoints = allDataPoints.filter(point => {
                var keywordMatch = keyword === '' 
                    ? true 
                    : point.小区.toLowerCase().includes(keyword) || point.区域.toLowerCase().includes(keyword);
                var priceMatch = point.单价 >= minPrice && point.单价 <= maxPrice;
                var totalPriceMatch = point.总价 >= minTotalPrice && point.总价 <= maxTotalPrice;
                var areaMatch = point.面积 >= minArea && point.面积 <= maxArea;
                return keywordMatch && priceMatch && totalPriceMatch && areaMatch;
            });

            showDataPoints(filteredPoints);
            updateResultCount(filteredPoints.length);
            if (filteredPoints.length === 0) alert('未找到符合条件的数据！');
        }

        // 重置筛选
        function resetAllConditions() {
            document.getElementById('keywordSearch').value = '';
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';
            document.getElementById('minTotalPrice').value = '';
            document.getElementById('maxTotalPrice').value = '';
            document.getElementById('minArea').value = '';
            document.getElementById('maxArea').value = '';
            showDataPoints(allDataPoints);
            updateResultCount(allDataPoints.length);
        }

        // 更新结果计数
        function updateResultCount(count) {
            document.getElementById('resultCount').textContent = 
                count === 0 ? '暂无数据' : 
                count === allDataPoints.length ? `共 ${count} 个数据点` : 
                `筛选结果：${count} 个数据点`;
        }

        // 弹窗相关功能
        function openPopup(type) {
            // 隐藏所有弹窗
            document.querySelectorAll('.popup-panel').forEach(panel => panel.style.display = 'none');
            // 显示对应弹窗
            if (type === 'heatmap') {
                document.getElementById('heatmapPopup').style.display = 'block';
                // 重置加载提示
                document.getElementById('heatmapLoading').style.display = 'block';
            }
            if (type === 'areaPrice') {
                document.getElementById('areaPricePopup').style.display = 'block';
                // 重置加载提示
                document.getElementById('areaPriceLoading').style.display = 'block';
            }
            if (type === 'suggest') document.getElementById('suggestPopup').style.display = 'block';
        }

        function closePopup(type) {
            if (type === 'heatmap') document.getElementById('heatmapPopup').style.display = 'none';
            if (type === 'areaPrice') document.getElementById('areaPricePopup').style.display = 'none';
            if (type === 'suggest') document.getElementById('suggestPopup').style.display = 'none';
            // 关闭时隐藏分析内容
            document.getElementById('heatmapSuggest').style.display = 'none';
            document.getElementById('areaPriceSuggest').style.display = 'none';
        }

        function toggleSuggest(type) {
            if (type === 'heatmap') {
                var elem = document.getElementById('heatmapSuggest');
                elem.style.display = elem.style.display === 'none' ? 'block' : 'none';
            }
            if (type === 'areaPrice') {
                var elem = document.getElementById('areaPriceSuggest');
                elem.style.display = elem.style.display === 'none' ? 'block' : 'none';
            }
        }

        // ==================== 新增：管理员登录功能 ====================
        function adminLogin() {
            const account = document.getElementById('adminAccount').value.trim();
            const pwd = document.getElementById('adminPwd').value.trim();
            const statusEl = document.getElementById('loginStatus');

            if (account === '123456' && pwd === '13456') {
                isAdmin = true;
                statusEl.className = 'login-status login-success';
                statusEl.textContent = '已登录（管理员）';
                document.getElementById('commentList').classList.add('admin-show');
                alert('管理员登录成功，已解锁评论删除功能！');
            } else {
                isAdmin = false;
                statusEl.className = 'login-status login-error';
                statusEl.textContent = '账号或密码错误';
                document.getElementById('commentList').classList.remove('admin-show');
            }
        }

        // ==================== 新增：评价功能 ====================
        // 打开评价面板
        function openCommentPanel(point) {
            if (!point) {
                alert('请先选择一个房源点位！');
                return;
            }
            currentSelectedPoint = point;
            document.getElementById('commentCommunityName').textContent = point.小区;
            document.getElementById('commentPanel').style.display = 'block';
            // 重置评分和输入框
            resetScore();
            document.getElementById('commentContent').value = '';
            // 加载该点位的评价
            loadComments(point.id);
            // 管理员登录状态更新
            if (isAdmin) {
                document.getElementById('commentList').classList.add('admin-show');
            } else {
                document.getElementById('commentList').classList.remove('admin-show');
            }
        }

        // 关闭评价面板
        function closeCommentPanel() {
            document.getElementById('commentPanel').style.display = 'none';
        }

        // 设置评分
        function setScore(score) {
            document.getElementById('currentScore').value = score;
            const stars = document.querySelectorAll('.score-star');
            stars.forEach((star, index) => {
                star.style.color = index < score ? '#ffc107' : '#ccc';
            });
        }

        // 重置评分
        function resetScore() {
            document.getElementById('currentScore').value = 0;
            const stars = document.querySelectorAll('.score-star');
            stars.forEach(star => {
                star.style.color = '#ccc';
            });
        }

        // 提交评价
        function submitComment() {
            if (!currentSelectedPoint) {
                alert('请先选择一个房源点位！');
                return;
            }
            const score = parseInt(document.getElementById('currentScore').value);
            const content = document.getElementById('commentContent').value.trim();
            
            if (score === 0) {
                alert('请选择评分！');
                return;
            }
            if (!content) {
                alert('请输入评价内容！');
                return;
            }

            // 生成评论ID
            const commentId = 'cmt_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
            // 构造评论数据
            const comment = {
                id: commentId,
                score: score,
                content: content,
                time: new Date().toLocaleString()
            };

            // 保存评论
            commentData[currentSelectedPoint.id].push(comment);
            // 重新加载评论
            loadComments(currentSelectedPoint.id);
            // 重置表单
            resetScore();
            document.getElementById('commentContent').value = '';
            alert('评价提交成功！');
        }

        // 加载评论
        function loadComments(pointId) {
            const commentListEl = document.getElementById('commentList');
            const comments = commentData[pointId] || [];

            if (comments.length === 0) {
                commentListEl.innerHTML = '<div class="comment-empty">暂无评价</div>';
                return;
            }

            let html = '';
            comments.forEach(comment => {
                // 生成星级显示
                let starsHtml = '';
                for (let i = 1; i <= 5; i++) {
                    starsHtml += `<span style="color: ${i <= comment.score ? '#ffc107' : '#ccc'}">★</span>`;
                }

                html += `
                    <div class="comment-item" data-comment-id="${comment.id}">
                        <div class="comment-score-display">${starsHtml}</div>
                        <div class="comment-content">
                            ${comment.content}
                            <span class="comment-delete" onclick="deleteComment(${pointId}, '${comment.id}')">删除</span>
                        </div>
                        <div class="comment-time">${comment.time}</div>
                    </div>
                `;
            });

            commentListEl.innerHTML = html;
            // 管理员状态更新
            if (isAdmin) {
                commentListEl.classList.add('admin-show');
            }
        }

        // 删除评论（管理员功能）
        function deleteComment(pointId, commentId) {
            if (!isAdmin) {
                alert('只有管理员可以删除评论！');
                return;
            }
            if (confirm('确定要删除这条评论吗？')) {
                // 过滤掉要删除的评论
                commentData[pointId] = commentData[pointId].filter(comment => comment.id !== commentId);
                // 重新加载评论
                loadComments(pointId);
            }
        }
    </script>
</body>
</html>
