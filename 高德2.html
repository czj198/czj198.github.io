<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高德地图可视化项目 - MVT数据筛选</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; }
        #mapContainer { width: 100%; height: 100%; }
        
        /* 图例样式 */
        #legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 200px;
        }
        
        .legend-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        .legend-label {
            font-size: 14px;
            color: #666;
        }
        
        /* 筛选控件样式 */
        #filterPanel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 300px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .filter-section {
            margin-bottom: 20px;
        }
        
        .filter-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }
        
        .filter-group {
            margin-bottom: 15px;
        }
        
        .filter-label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #666;
        }
        
        .filter-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .filter-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            height: 120px;
        }
        
        .filter-button {
            width: 100%;
            padding: 10px;
            background: #1e5799;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .filter-button:hover {
            background: #16457a;
        }
        
        .filter-button.reset {
            background: #666;
        }
        
        .filter-button.reset:hover {
            background: #555;
        }
        
        .range-inputs {
            display: flex;
            gap: 10px;
        }
        
        .range-inputs input {
            flex: 1;
        }
        
        .info-text {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        /* 属性信息面板 */
        #propertyPanel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1001;
            width: 300px;
            display: none;
        }
        
        .property-item {
            margin: 10px 0;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .property-key {
            font-weight: bold;
            color: #1e5799;
        }
    </style>
</head>
<body>
    <div id="mapContainer"></div>
    
    <!-- 图例 -->
    <div id="legend">
        <div class="legend-title">单价图例</div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #ff0000;"></div>
            <div class="legend-label">单价 > 10000元/㎡</div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #0066cc;"></div>
            <div class="legend-label">单价 ≤ 10000元/㎡</div>
        </div>
    </div>
    
    <!-- 筛选控件 -->
    <div id="filterPanel">
        <div class="filter-section">
            <div class="filter-title">数据筛选</div>
            
            <!-- 区域筛选 -->
            <div class="filter-group">
                <label class="filter-label">选择区域:</label>
                <select multiple class="filter-select" id="regionSelect">
                    <!-- 区域选项将通过JavaScript动态填充 -->
                </select>
                <div class="info-text">按住Ctrl可多选，不选则显示所有区域</div>
            </div>
            
            <!-- 单价区间筛选 -->
            <div class="filter-group">
                <label class="filter-label">单价区间（元/㎡）:</label>
                <div class="range-inputs">
                    <input type="number" id="minPrice" class="filter-input" placeholder="最低单价">
                    <input type="number" id="maxPrice" class="filter-input" placeholder="最高单价">
                </div>
            </div>
            
            <!-- 总价区间筛选 -->
            <div class="filter-group">
                <label class="filter-label">总价区间（万元）:</label>
                <div class="range-inputs">
                    <input type="number" id="minTotalPrice" class="filter-input" placeholder="最低总价">
                    <input type="number" id="maxTotalPrice" class="filter-input" placeholder="最高总价">
                </div>
            </div>
            
            <!-- 面积筛选 -->
            <div class="filter-group">
                <label class="filter-label">面积区间（㎡）:</label>
                <div class="range-inputs">
                    <input type="number" id="minArea" class="filter-input" placeholder="最小面积">
                    <input type="number" id="maxArea" class="filter-input" placeholder="最大面积">
                </div>
            </div>
            
            <!-- 操作按钮 -->
            <button class="filter-button" id="applyFilter">应用筛选</button>
            <button class="filter-button reset" id="resetFilter">重置筛选</button>
            
            <!-- 统计信息 -->
            <div class="filter-group">
                <div class="info-text" id="resultCount">共 159 个数据点</div>
            </div>
        </div>
    </div>

    <!-- 属性信息面板 -->
    <div id="propertyPanel">
        <div class="property-item">
            <span class="property-key">小区:</span> <span id="propCommunity"></span>
        </div>
        <div class="property-item">
            <span class="property-key">区域:</span> <span id="propRegion"></span>
        </div>
        <div class="property-item">
            <span class="property-key">房型:</span> <span id="propLayout"></span>
        </div>
        <div class="property-item">
            <span class="property-key">面积:</span> <span id="propArea"></span> ㎡
        </div>
        <div class="property-item">
            <span class="property-key">单价:</span> <span id="propUnitPrice"></span> 元/㎡
        </div>
        <div class="property-item">
            <span class="property-key">总价:</span> <span id="propTotalPrice"></span> 万元
        </div>
        <button class="filter-button" onclick="document.getElementById('propertyPanel').style.display='none'">关闭</button>
    </div>

    <!-- 配置安全密钥 -->
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: '7e5f2c0059d4114aa0a0141f0182b0c1'
        };
    </script>

    <!-- 引入高德地图API -->
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=a19e8b46119d6277b2f366ab1d2f552c&plugin=AMap.Visual,AMap.DistrictSearch"></script>
    
    <script type="text/javascript">
        // 创建地图 - 中心点设为武汉
        var map = new AMap.Map('mapContainer', {
            zoom: 12,
            center: [114.305, 30.593]  // 武汉中心坐标
        });

        // 存储所有数据点和当前显示的标记
        var allDataPoints = [];
        var currentMarkers = [];
        var regions = [];

        // 加载可视化项目
        var visual = new AMap.Visual('amap://visual/bf9105f25aa5bf2578aa2de84cc4a687', map);

        console.log('可视化项目加载中，中心点：武汉');

        // 监听加载事件
        visual.on('complete', function () {
            console.log('✅ 可视化项目加载完成');
            // 从MVT数据源加载真实数据
            loadMVTData();
        });

        visual.on('error', function (error) {
            console.log('❌ 可视化项目加载失败:', error);
        });

        // 从MVT数据源加载数据
        function loadMVTData() {
            // 这里需要调用高德数据发布服务的API来获取MVT数据属性
            // 由于直接访问MVT属性数据需要特定API，这里先使用模拟数据演示
            // 实际使用时需要替换为真实的高德数据发布服务API调用
            
            console.log('正在从MVT数据源加载数据...');
            console.log('数据源ID: b203c9b8-1bac-4552-8c34-4f7a10c85a17');
            
            // 模拟从MVT加载的真实数据结构
            simulateMVTDataLoad();
        }

        // 模拟MVT数据加载（实际使用时替换为真实API调用）
        function simulateMVTDataLoad() {
            // 模拟武汉的主要区域
            var wuhanRegions = ['江岸区', '江汉区', '硚口区', '汉阳区', '武昌区', '青山区', '洪山区', '东西湖区', '汉南区', '蔡甸区', '江夏区', '黄陂区', '新洲区'];
            var layouts = ['2室1厅', '3室1厅', '3室2厅', '4室2厅', '2室2厅'];
            
            // 生成159个模拟数据点，基于您提供的字段结构
            for (var i = 0; i < 159; i++) {
                var region = wuhanRegions[Math.floor(Math.random() * wuhanRegions.length)];
                var unitPrice = Math.floor(Math.random() * 15000) + 5000; // 5000-20000元/㎡
                var area = Math.floor(Math.random() * 150) + 50; // 50-200㎡
                var totalPrice = (unitPrice * area / 10000).toFixed(2); // 总价（万元）
                var layout = layouts[Math.floor(Math.random() * layouts.length)];
                
                // 在武汉范围内随机生成坐标
                var lng = 114.2 + Math.random() * 0.3; // 114.2-114.5
                var lat = 30.5 + Math.random() * 0.2;  // 30.5-30.7
                
                allDataPoints.push({
                    id: i + 1,
                    小区: '小区' + (i + 1),
                    区域: region,
                    房型: layout,
                    面积: area,
                    单价: unitPrice,
                    总价: parseFloat(totalPrice),
                    lnglat: [lng, lat],
                    color: unitPrice > 10000 ? '#ff0000' : '#0066cc'
                });
            }
            
            // 初始化筛选控件
            initFilterControls();
            // 显示所有点
            showDataPoints(allDataPoints);
            updateResultCount(allDataPoints.length);
            
            console.log('✅ MVT数据加载完成，共', allDataPoints.length, '个数据点');
        }

        // 显示数据点在地图上
        function showDataPoints(points) {
            // 清除现有标记
            clearMarkers();
            
            // 添加新标记
            points.forEach(function(point) {
                var marker = new AMap.Marker({
                    position: point.lnglat,
                    title: point.小区 + ' - ' + point.单价 + '元/㎡',
                    content: createMarkerContent(point),
                    offset: new AMap.Pixel(-8, -8)
                });
                
                // 添加点击事件显示属性信息
                marker.on('click', function() {
                    showPropertyInfo(point);
                });
                
                marker.setMap(map);
                currentMarkers.push(marker);
            });
        }

        // 创建标记内容
        function createMarkerContent(point) {
            return '<div style="width:16px;height:16px;background-color:' + point.color + 
                   ';border-radius:50%;border:2px solid white;box-shadow:0 1px 3px rgba(0,0,0,0.3);cursor:pointer;" title="' + 
                   point.小区 + ' - ' + point.单价 + '元/㎡"></div>';
        }

        // 清除所有标记
        function clearMarkers() {
            currentMarkers.forEach(function(marker) {
                marker.setMap(null);
            });
            currentMarkers = [];
        }

        // 显示属性信息
        function showPropertyInfo(point) {
            document.getElementById('propCommunity').textContent = point.小区;
            document.getElementById('propRegion').textContent = point.区域;
            document.getElementById('propLayout').textContent = point.房型;
            document.getElementById('propArea').textContent = point.面积;
            document.getElementById('propUnitPrice').textContent = point.单价;
            document.getElementById('propTotalPrice').textContent = point.总价;
            document.getElementById('propertyPanel').style.display = 'block';
        }

        // 初始化筛选控件
        function initFilterControls() {
            // 获取所有区域并去重
            regions = [...new Set(allDataPoints.map(point => point.区域))];
            
            // 填充区域选择框
            var regionSelect = document.getElementById('regionSelect');
            regions.forEach(function(region) {
                var option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                regionSelect.appendChild(option);
            });
            
            // 绑定筛选按钮事件
            document.getElementById('applyFilter').addEventListener('click', applyFilters);
            document.getElementById('resetFilter').addEventListener('click', resetFilters);
        }

        // 应用筛选条件
        function applyFilters() {
            var selectedRegions = getSelectedRegions();
            var minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
            var maxPrice = parseFloat(document.getElementById('maxPrice').value) || Infinity;
            var minTotalPrice = parseFloat(document.getElementById('minTotalPrice').value) || 0;
            var maxTotalPrice = parseFloat(document.getElementById('maxTotalPrice').value) || Infinity;
            var minArea = parseFloat(document.getElementById('minArea').value) || 0;
            var maxArea = parseFloat(document.getElementById('maxArea').value) || Infinity;
            
            // 筛选数据
            var filteredPoints = allDataPoints.filter(function(point) {
                // 区域筛选
                var regionMatch = selectedRegions.length === 0 || selectedRegions.includes(point.区域);
                
                // 单价筛选
                var priceMatch = point.单价 >= minPrice && point.单价 <= maxPrice;
                
                // 总价筛选
                var totalPriceMatch = point.总价 >= minTotalPrice && point.总价 <= maxTotalPrice;
                
                // 面积筛选
                var areaMatch = point.面积 >= minArea && point.面积 <= maxArea;
                
                return regionMatch && priceMatch && totalPriceMatch && areaMatch;
            });
            
            // 显示筛选结果
            showDataPoints(filteredPoints);
            updateResultCount(filteredPoints.length);
        }

        // 获取选中的区域
        function getSelectedRegions() {
            var regionSelect = document.getElementById('regionSelect');
            var selectedRegions = [];
            for (var i = 0; i < regionSelect.options.length; i++) {
                if (regionSelect.options[i].selected) {
                    selectedRegions.push(regionSelect.options[i].value);
                }
            }
            return selectedRegions;
        }

        // 重置筛选条件
        function resetFilters() {
            document.getElementById('regionSelect').selectedIndex = -1;
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';
            document.getElementById('minTotalPrice').value = '';
            document.getElementById('maxTotalPrice').value = '';
            document.getElementById('minArea').value = '';
            document.getElementById('maxArea').value = '';
            
            // 显示所有点
            showDataPoints(allDataPoints);
            updateResultCount(allDataPoints.length);
        }

        // 更新结果计数
        function updateResultCount(count) {
            document.getElementById('resultCount').textContent = '共 ' + count + ' 个数据点';
        }

        // 实际的高德数据发布服务API调用函数（需要根据实际API文档实现）
        async function fetchMVTDataFromAPI() {
            try {
                // 这里需要根据高德数据发布服务的实际API进行调用
                // const response = await fetch(`https://yuntuapi.amap.com/datasearch/vector?key=您的key&tableid=b203c9b8-1bac-4552-8c34-4f7a10c85a17&keywords=&city=武汉&limit=159`);
                // const data = await response.json();
                // return data.datas; // 根据实际API响应结构调整
                
                console.log('需要实现真实的高德数据发布服务API调用');
                return [];
            } catch (error) {
                console.error('API调用失败:', error);
                return [];
            }
        }
    </script>
</body>
</html>